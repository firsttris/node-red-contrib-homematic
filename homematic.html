<script type="text/x-red" data-template-name="homematic">
	<div class="form-row" id="node-form-_method">
        <label for="node-input-_method"><i class="fa fa-list"></i> Method</label>
		<select id="node-input-_method">
			<option value="Session.login">Session.login</option>
			<option value="Session.logout">Session.logout</option>
            <option value="Interface.setValue">Interface.setValue</option>
			<option value="Interface.getValue">Interface.getValue</option>
			<option value="Interface.init">Interface.init</option>
			<option value="Device.listAllDetail">Device.listAllDetail</option>
			<option value="Device.listAll">Device.listAll</option>
			<option value="Event.poll">Event.poll</option>
			<option value="Event.subscribe">Event.subscribe</option>
			<option value="Event.unsubscribe">Event.unsubscribe</option>
        </select>
    </div>
	<div class="form-row hidden" id="node-form-_interface">
        <label for="node-input-_interface"><i class="fa fa-list"></i> Interface</label>
		<select id="node-input-_interface">
			<option value=""></option>
            <option value="BidCos-RF">BidCos-RF</option>
        </select>
    </div>
	<div class="form-row" id="node-form-_address">
        <label for="node-input-_address"><i class="fa fa-list"></i> Address</label>
		<select id="node-input-_address">
			<option value=""></option>
            <option value="LEQ0996940:2">LEQ0996940:2 Thermostat Unten</option>
			<option value="LEQ0990753:1">LEQ0990753:1 Dimmer Bett</option>
			<option value="LEQ0850231:4">LEQ0850231:4 Thermostat Bad</option>
			<option value="customAddress">Custom Adress</option>
        </select>
    </div>
	<div class="form-row" id="node-form-_customAddress">
        <label for="node-input-_customAddress"><i class="fa fa-tag"></i> Adress</label>
        <input type="text" id="node-input-_customAddress" placeholder="Adress">
    </div>
	<div class="form-row" id="node-form-_valueKey">
        <label for="node-input-_valueKey"><i class="fa fa-list"></i> ValueKey</label>
		<select id="node-input-_valueKey">
			<option value=""></option>
            <option value="ACTUAL_TEMPERATURE">ACTUAL_TEMPERATURE</option>
			<option value="ACTUAL_HUMIDITY">ACTUAL_HUMIDITY</option>
			<option value="SET_TEMPERATURE">SET_TEMPERATURE</option>
			<option value="MANU_MODE">MANU_MODE</option>
			<option value="AUTO_MODE">AUTO_MODE</option>
			<option value="BOOST_MODE">BOOST_MODE</option>
			<option value="COMFORT_MODE">COMFORT_MODE</option>
			<option value="LOWERING_MODE">LOWERING_MODE</option>
			<option value="PARTY_MODE_SUBMIT">PARTY_MODE_SUBMIT</option>
			<option value="PARTY_TEMPERATURE">PARTY_TEMPERATURE</option>			
			<option value="LEVEL">LEVEL</option>
        </select>
    </div>
	<div class="form-row" id="node-form-_type">
        <label for="node-input-_type"><i class="fa fa-list"></i> Type</label>
		<select id="node-input-_type">
			<option value=""></option>
            <option value="boolean">boolean</option>
			<option value="string">string</option>
        </select>
    </div>
	<div class="form-row" id="node-form-_username">
        <label for="node-input-_username"><i class="fa fa-tag"></i> Username</label>
        <input type="text" id="node-input-_username" placeholder="Username">
    </div>
		<div class="form-row" id="node-form-_password">
        <label for="node-input-_password"><i class="fa fa-tag"></i> Password</label>
        <input type="password" id="node-input-_password" placeholder="Password">
    </div>
	<div class="form-row" id="node-form-_url">
        <label for="node-input-_url"><i class="fa fa-tag"></i> URL</label>
        <input type="text" id="node-input-_url" placeholder="URL">
    </div>
	<div class="form-row" id="node-form-_interfaceId">
        <label for="node-input-_interfaceId"><i class="fa fa-tag"></i> InterfaceId</label>
        <input type="text" id="node-input-_interfaceId" placeholder="InterfaceId">
    </div>
	<div class="form-row" id="node-form-_value">
        <label for="node-input-_value"><i class="fa fa-tag"></i> Value</label>
        <input type="text" id="node-input-_value" placeholder="Value">
    </div>
	<div class="form-row" id="node-form-_topic">
        <label for="node-input-_topic"><i class="fa fa-tag"></i> Topic</label>
        <input type="text" id="node-input-_topic" placeholder="Topic">
    </div>
	<div class="form-row" id="node-form-_name">
        <label for="node-input-_name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-_name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="homematic">
    <p>This Node provides predefined commands to control homematic devices 
       using the JSON-RPC API.</p>
    <p>Select a method and fill in the required fields.</p>
	<p></p
    <p><b>Outputs:</b> remote procedure calls which can be 
          send using http-request node</p>
	<p></p>
	<p>API Documentation: ipofyourcc2/api/homematic.cgi</p>
	<p></p>
	<p>You can easily extend this module to fit your needs
	by editing the html file.</p> 
	<p>Pull requests are welcome
	<a href="https://github.com/firsttris/node-red-contrib-homematic" target="_blank">Github</a>
	</p>
</script>

<script type="text/javascript">
RED.nodes.registerType('homematic',{
    category: 'function',
    color:"#ecf0f1",
    defaults : {
	_method: {value:"",required:true},
	_interface: {value:""},
	_address: {value:""},
	_valueKey: {value:""},
	_type: {value:""},
	_url: {value:""},
	_interfaceId: {value:""},
	_value: {value:""},
	_topic: {value:""},
	_customAddress: {value:""},
	_username: {value:""},
	_password: {value:""},
	_name: {value:""},
    },
    inputs:1,
    outputs:1,
    icon : "envelope.png",
    label: function() {
	return this._name || "homematic";
    },
    labelStyle: function() {
	return (this._name)?"node_label_italic":"";
    },
    oneditprepare: function() {

	$("#node-input-_address").change(function () {
	    var selectedAdress = $("#node-input-_address").val();
	    hideAndShowOnAdressChange(selectedAdress);
	    clearValuesOnAdressChange(selectedAdress);
	});
	$("#node-input-_address").change();

	$("#node-input-_method").change(function () {
	    var selectedMethod = $("#node-input-_method").val();
	    clearValuesOnMethodChange(selectedMethod);
	    hideAndShowOnMethodChange(selectedMethod);
	});
	$("#node-input-method").change();

	function hideAndShowOnAdressChange(selectedAdress) {

	    if (selectedAdress === "customAddress") {
		$("#node-form-_customAddress").show();
	    } else {
		$("#node-form-_customAddress").hide();
	    }

	}

	function clearValuesOnAdressChange(selectedAdress) {

	    if (selectedAdress !== "customAddress") {
		$("#node-input-_customAddress").val("");
	    } 

	}

	function hideAndShowOnMethodChange(selectedMethod) {

	    if (selectedMethod === "Session.login") {
		hideFields(true, true, true, true, false, false, true, true, true);
	    }
	    else if (selectedMethod === "Session.logout") {
		hideFields(true, true, true, true, true, true, true, true, true);
	    }
	    else if (selectedMethod === "Interface.setValue") {
		hideFields(false, false, false, false, true, true, false, true, true);
	    }
	    else if (selectedMethod === "Interface.getValue") {
		hideFields(false, false, false, true, true, true, true, true, true);
	    }				
	    else if (selectedMethod === "Interface.init") {
		hideFields(false, true, true, true, true, true, true, false, false);
	    }
	    else if (selectedMethod === "Device.listAllDetail") {
		hideFields(true, true, true, true, true, true, true, true, true);
	    }
	    else if (selectedMethod === "Device.listAll") {
		hideFields(true, true, true, true, true, true, true, true, true);
	    }
	}

	function hideFields(_interface, _address, _valueKey, _type, _username, _password, _value, _url, _interfaceId) {
	    if(_interface) {
		$("#node-form-_interface").hide();
	    } else { 
		$("#node-form-_interface").show();
	    }

	    if(_address) {
		$("#node-form-_address").hide();
	    } else { 
		$("#node-form-_address").show();
	    }

	    if(_valueKey) {
		$("#node-form-_valueKey").hide();
	    } else { 
		$("#node-form-_valueKey").show();
	    }

	    if(_type) {
		$("#node-form-_type").hide();
	    } else { 
		$("#node-form-_type").show();
	    }

	    if(_username) {
		$("#node-form-_username").hide();
	    } else { 
		$("#node-form-_username").show();
	    }

	    if(_password) {
		$("#node-form-_password").hide();
	    } else { 
		$("#node-form-_password").show();
	    }

	    if(_value) {
		$("#node-form-_value").hide();
	    } else { 
		$("#node-form-_value").show();
	    }

	    if(_url) {
		$("#node-form-_url").hide();
	    } else { 
		$("#node-form-_url").show();
	    }

	    if(_interfaceId) {
		$("#node-form-_interfaceId").hide();
	    } else { 
		$("#node-form-_interfaceId").show();
	    }
	}

	function clearValuesOnMethodChange(selectedMethod) {

	    if (selectedMethod === "Session.login") {
		clearValueOnField(true, true, true, true, false, false, true, true, true);
	    }
	    else if (selectedMethod === "Session.logout") {
		clearValueOnField(true, true, true, true, true, true, true, true, true);
	    }
	    else if (selectedMethod === "Interface.setValue") {
		clearValueOnField(false, false, false, false, true, true, false, false, false);
	    }
	    else if (selectedMethod === "Interface.getValue") {
		clearValueOnField(false, false, false, true, true, true, true, true, true);
	    }
	    else if (selectedMethod === "Interface.init") {
		clearValueOnField(false, true, true, true, true, true, true, false, false);
	    }
	    else if (selectedMethod === "Device.listAllDetail") {
		clearValueOnField(true, true, true, true, true, true, true, true, true);
	    }
	    else if (selectedMethod === "Device.listAll") {
		clearValueOnField(true, true, true, true, true, true, true, true, true);
	    }
	    else if (selectedMethod === "Event.poll") {
		clearValueOnField(true, true, true, true, true, true, true, true, true);
	    }
	    else if (selectedMethod === "Event.subscribe") {
		clearValueOnField(true, true, true, true, true, true, true, true, true);
	    }
	    else if (selectedMethod === "Event.unsubscribe") {
		clearValueOnField(true, true, true, true, true, true, true, true, true);
	    }

	}

	function clearValueOnField(_interface, _address, _valueKey, _type, _username, _password, _value, _url, _interfaceId) {
	    if(_interface)
		$("#node-input-_interface").prop("selectedIndex", 0);
	    if(_address)
		$("#node-input-_address").prop("selectedIndex", 0);
	    if(_valueKey)
		$("#node-input-_valueKey").prop("selectedIndex", 0);
	    if(_type)
		$("#node-input-_type").prop("selectedIndex", 0);
	    if(_username)
		$("#node-input-_username").val("");
	    if(_password)
		$("#node-input-_password").val("");
	    if(_value)
		$("#node-input-_value").val("");
	    if(_url)
		$("#node-input-_url").val("");
	    if(_interfaceId)
		$("#node-input-_interfaceId").val("");
	}

    },
    oneditsave : function () {		
	$("#node-input-_name").val($("#node-input-_method").val()+" "+$("#node-input-_address").val()+" "+$("#node-input-_valueKey").val());
	$("#node-input-_topic").val($("#node-input-_method").val()+"_"+$("#node-input-_address").val()+"_"+$("#node-input-_valueKey").val());
    }
});
</script>